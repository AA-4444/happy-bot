{# templates/edit.html #}
{% extends "base.html" %}
{% block content %}
  <div class="flex items-center justify-between">
	<h1 class="text-base font-medium">{{ "New block" if is_new else "Edit block" }}</h1>
	<a href="/flow/{{ block.get('flow','') }}" class="text-sm text-white/50 hover:text-white/70">‚Üê back</a>
  </div>

  {% if error %}
	<div class="mt-4 rounded-xl border border-red-500/20 bg-red-500/10 p-3 text-sm text-red-200">
	  {{ error }}
	</div>
  {% endif %}

  <form class="mt-6 space-y-4" method="post" action="/block/save" enctype="multipart/form-data">
	<input type="hidden" name="block_id" value="{{ block.get('id', 0) }}" />

	{# —á—Ç–æ–±—ã –µ—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ –µ—Å—Ç—å ‚Äî –æ–Ω –Ω–µ –ø—Ä–æ–ø–∞–ª –ø—Ä–∏ Save –±–µ–∑ –Ω–æ–≤–æ–≥–æ upload #}
	<input type="hidden" name="file_path" value="{{ block.get('file_path','') }}" />
	<input type="hidden" name="file_kind" value="{{ block.get('file_kind','') }}" />
	<input type="hidden" name="file_name" value="{{ block.get('file_name','') }}" />

	<div class="grid grid-cols-1 md:grid-cols-3 gap-3">
	  <div>
		<label class="text-xs text-white/50">flow</label>
		<input
		  name="flow"
		  value="{{ block.get('flow','') }}"
		  class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/15"
		/>
	  </div>

	  <div>
		<label class="text-xs text-white/50">position</label>
		<input
		  name="position"
		  type="number"
		  value="{{ block.get('position', 1) }}"
		  class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/15"
		/>
	  </div>

	  <div>
		<label class="text-xs text-white/50">type</label>
		<select
		  id="typeSel"
		  name="type"
		  class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/15"
		>
		  {% set cur_type = block.get('type','text') %}
		  {% for t in ["text","circle","video","buttons"] %}
			<option value="{{ t }}" {% if cur_type == t %}selected{% endif %}>{{ t }}</option>
		  {% endfor %}
		</select>
	  </div>
	</div>

	<div class="grid grid-cols-1 md:grid-cols-3 gap-3">
	  <div>
		<label class="text-xs text-white/50">title (–¥–ª—è video/buttons)</label>
		<input
		  name="title"
		  value="{{ block.get('title','') }}"
		  class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/15"
		/>
	  </div>

	  <div>
		<label class="text-xs text-white/50">delay</label>
		<div class="text-[11px] text-white/35 -mt-0.5">–º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –¥—Ä–æ–±–Ω—ã–µ —Å–µ–∫—É–Ω–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä 1.2)</div>
		<input
		  name="delay_seconds"
		  type="number"
		  step="0.1"
		  value="{{ block.get('delay', 1.0) }}"
		  class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/15"
		/>
	  </div>

	  <div>
		<label class="text-xs text-white/50">is_active (0/1)</label>
		<input
		  name="is_active"
		  type="number"
		  value="{{ block.get('is_active', 1) }}"
		  class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/15"
		/>
	  </div>
	</div>

	<!-- TEXT -->
	<div id="secText">
	  <label class="text-xs text-white/50">text</label>
	  <textarea
		name="text"
		rows="6"
		class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/15"
	  >{{ block.get('text','') }}</textarea>
	</div>

	<!-- MEDIA -->
	<div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="secMedia">
	  <div>
		<label class="text-xs text-white/50">circle_path (–∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª)</label>
		<input
		  name="circle_path"
		  value="{{ block.get('circle','') }}"
		  class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/15"
		/>
		<div class="mt-2">
		  <input type="file" name="circle_file" class="text-sm text-white/70" />
		</div>

		{% if block.get('circle') %}
		  <div class="mt-2 text-[11px] text-white/45">current: {{ block.get('circle') }}</div>
		{% endif %}
	  </div>

	  <div>
		<label class="text-xs text-white/50">video_url</label>
		<input
		  name="video_url"
		  value="{{ block.get('video','') }}"
		  class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/15"
		/>
	  </div>
	</div>

	<!-- ATTACHMENT -->
	<div class="rounded-2xl border border-white/10 bg-white/[0.02] p-4">
	  <div class="flex items-center justify-between mb-3">
		<div class="text-sm font-medium">Attachment</div>
		<div class="text-xs text-white/40">–ª—é–±–æ–π —Ñ–∞–π–ª (pdf/docx/png/zip –∏ —Ç.–¥.)</div>
	  </div>

	  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
		<div>
		  <label class="text-xs text-white/50">upload file</label>
		  <input type="file" name="attach_file" class="block mt-2 text-sm text-white/70" />
		  <div class="text-[11px] text-white/35 mt-2">
			–ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏—à—å ‚Äî —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ <code>media/</code> –∏ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –±–æ—Ç–æ–º –≤ —ç—Ç–æ–º –±–ª–æ–∫–µ.
		  </div>
		</div>

		<div>
		  <label class="text-xs text-white/50">current</label>
		  <div class="mt-2 text-sm text-white/80">
			{% if block.get('file_path') %}
			  <div class="text-[11px] text-white/45">kind: {{ block.get('file_kind','') }}</div>
			  <a class="text-white/80 underline" href="{{ block.get('file_path') }}" target="_blank">{{ block.get('file_path') }}</a>
			{% else %}
			  <span class="text-white/35">‚Äî</span>
			{% endif %}
		  </div>

		  <div class="mt-3">
			<button
			  type="button"
			  class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-sm hover:bg-white/10"
			  onclick="clearAttachment()"
			>
			  Clear attachment
			</button>
		  </div>
		</div>
	  </div>
	</div>

	<!-- ‚úÖ NEXT LESSON GATE -->
	<div class="rounded-2xl border border-white/10 bg-white/[0.02] p-4">
	  <div class="flex items-center justify-between mb-3">
		<div class="text-sm font-medium">Next lesson gate</div>
		<div class="text-xs text-white/40">–∫–Ω–æ–ø–∫–∞ ‚Äú–ì–æ—Ç–æ–≤‚Ä¶‚Äù + –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</div>
	  </div>

	  <div class="text-[11px] text-white/40 mb-4">
		–ï—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å <b>Next flow</b> ‚Äî –±–æ—Ç –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∏ –ø–æ–∫–∞–∂–µ—Ç –∫–Ω–æ–ø–∫—É.
		–ü–æ –Ω–∞–∂–∞—Ç–∏—é ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π flow.
	  </div>

	  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
		<div>
		  <label class="text-xs text-white/50">Next flow (—á—Ç–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ—Å–ª–µ –∫–Ω–æ–ø–∫–∏)</label>

		  {% if flows is defined and flows %}
			<select
			  name="gate_next_flow"
			  class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/15"
			>
			  <option value="">‚Äî disabled ‚Äî</option>
			  {% for f in flows %}
				<option value="{{ f }}" {% if block.get('gate_next_flow','') == f %}selected{% endif %}>{{ f }}</option>
			  {% endfor %}
			</select>
		  {% else %}
			<input
			  name="gate_next_flow"
			  value="{{ block.get('gate_next_flow','') }}"
			  class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/15"
			  placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: day2"
			/>
			<div class="text-[11px] text-white/35 mt-1">
			  (—á—Ç–æ–±—ã –±—ã–ª dropdown ‚Äî –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å <code>flows</code> –≤ —à–∞–±–ª–æ–Ω –∏–∑ crm.py)
			</div>
		  {% endif %}
		</div>

		<div>
		  <label class="text-xs text-white/50">Button text</label>
		  <input
			name="gate_button_text"
			value="{{ block.get('gate_button_text') or '‚úÖ –ì–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É—Ä–æ–∫—É' }}"
			class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/15"
		  />
		</div>
	  </div>

	  <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
		<div>
		  <label class="text-xs text-white/50">Reminder</label>
		  <input
			name="gate_reminder_value"
			type="number"
			min="0"
			value="{{ block.get('gate_reminder_value', 0) }}"
			class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/15"
			placeholder="0"
		  />
		  <div class="text-[11px] text-white/35 mt-1">0 = –±–µ–∑ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</div>
		</div>

		<div>
		  <label class="text-xs text-white/50">Unit</label>
		  {% set u = (block.get('gate_reminder_unit') or 'hours') %}
		  <select
			name="gate_reminder_unit"
			class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/15"
		  >
			<option value="minutes" {% if u=='minutes' %}selected{% endif %}>minutes</option>
			<option value="hours" {% if u=='hours' %}selected{% endif %}>hours</option>
			<option value="days" {% if u=='days' %}selected{% endif %}>days</option>
		  </select>
		</div>

		<div>
		  <label class="text-xs text-white/50">Reminder text (optional)</label>
		  <input
			name="gate_reminder_text"
			value="{{ block.get('gate_reminder_text','') }}"
			class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/15"
			placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢—ã –≥–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? üôÇ"
		  />
		</div>
	  </div>

	  <div class="mt-3 flex items-center gap-3">
		<button
		  type="button"
		  class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-sm hover:bg-white/10"
		  onclick="clearGate()"
		>
		  Disable gate
		</button>
		<div class="text-[11px] text-white/35">
		  Disabled = –ø–æ–ª–µ Next flow —Å—Ç–∞–Ω–µ—Ç –ø—É—Å—Ç—ã–º (gate –≤—ã–∫–ª—é—á–µ–Ω).
		</div>
	  </div>
	</div>

	<!-- BUTTONS EASY MODE -->
	<div id="secButtons" class="rounded-2xl border border-white/10 bg-white/[0.02] p-4">
	  <div class="flex items-center justify-between mb-3">
		<div class="text-sm font-medium">Buttons</div>
		<div class="text-xs text-white/40">–¥–æ 3 –∫–Ω–æ–ø–æ–∫</div>
	  </div>

	  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
		<div>
		  <label class="text-xs text-white/50">Button 1 text</label>
		  <input
			name="btn1_text"
			value="{{ block.get('btn1_text','') }}"
			class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10"
			placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç"
		  />
		</div>
		<div>
		  <label class="text-xs text-white/50">Button 1 url</label>
		  <input
			name="btn1_url"
			value="{{ block.get('btn1_url','') }}"
			class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10"
			placeholder="https://..."
		  />
		</div>

		<div>
		  <label class="text-xs text-white/50">Button 2 text</label>
		  <input
			name="btn2_text"
			value="{{ block.get('btn2_text','') }}"
			class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10"
			placeholder="(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
		  />
		</div>
		<div>
		  <label class="text-xs text-white/50">Button 2 url</label>
		  <input
			name="btn2_url"
			value="{{ block.get('btn2_url','') }}"
			class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10"
			placeholder="https://..."
		  />
		</div>

		<div>
		  <label class="text-xs text-white/50">Button 3 text</label>
		  <input
			name="btn3_text"
			value="{{ block.get('btn3_text','') }}"
			class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10"
			placeholder="(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
		  />
		</div>
		<div>
		  <label class="text-xs text-white/50">Button 3 url</label>
		  <input
			name="btn3_url"
			value="{{ block.get('btn3_url','') }}"
			class="w-full mt-1 px-3 py-2 rounded-xl bg-black/40 border border-white/10"
			placeholder="https://..."
		  />
		</div>
	  </div>

	  <details class="mt-4">
		<summary class="text-xs text-white/50 cursor-pointer">Advanced (JSON)</summary>
		<textarea
		  name="buttons_json"
		  rows="4"
		  class="w-full mt-2 px-3 py-2 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/15"
		>{{ block.get('buttons_json','') or block.get('buttons','') }}</textarea>
		<div class="text-[11px] text-white/35 mt-1">
		  –ï—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ ‚Äî –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω JSON. –ò–Ω–∞—á–µ –±–µ—Ä—ë–º –∫–Ω–æ–ø–∫–∏ —Å–≤–µ—Ä—Ö—É.
		</div>
	  </details>
	</div>

	<button class="px-4 py-2 rounded-xl bg-white text-black text-sm font-medium hover:opacity-90">
	  Save
	</button>
  </form>

  <script>
	function toggleSections() {
	  const secButtons = document.getElementById("secButtons");
	  if (secButtons) {
		secButtons.style.display = "block";
		secButtons.style.opacity = "1";
		secButtons.style.pointerEvents = "auto";
		secButtons.querySelectorAll("input, textarea").forEach(i => i.disabled = false);
	  }
	}

	function clearAttachment() {
	  const fp = document.querySelector('input[name="file_path"]');
	  const fk = document.querySelector('input[name="file_kind"]');
	  const fn = document.querySelector('input[name="file_name"]');
	  if (fp) fp.value = '';
	  if (fk) fk.value = '';
	  if (fn) fn.value = '';
	  alert('Attachment –æ—á–∏—â–µ–Ω. –ù–∞–∂–º–∏ Save.');
	}

	function clearGate() {
	  const nf = document.querySelector('[name="gate_next_flow"]');
	  const bt = document.querySelector('[name="gate_button_text"]');
	  const rv = document.querySelector('[name="gate_reminder_value"]');
	  const ru = document.querySelector('[name="gate_reminder_unit"]');
	  const rt = document.querySelector('[name="gate_reminder_text"]');

	  if (nf) nf.value = '';
	  if (bt) bt.value = '';
	  if (rv) rv.value = '0';
	  if (ru) ru.value = 'hours';
	  if (rt) rt.value = '';

	  alert('Gate –æ—Ç–∫–ª—é—á—ë–Ω. –ù–∞–∂–º–∏ Save.');
	}

	const typeSel = document.getElementById("typeSel");
	if (typeSel) typeSel.addEventListener("change", toggleSections);
	toggleSections();
  </script>
{% endblock %}