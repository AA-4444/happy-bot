{% extends "base.html" %}
{% block content %}

  <!-- STATS -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
	<div class="rounded-xl border border-white/10 bg-white/[0.02] p-4">
	  <div class="text-xs text-white/40">Users</div>
	  <div class="text-xl font-semibold">{{ stats.total_users if stats is defined else "-" }}</div>
	</div>

	<div class="rounded-xl border border-white/10 bg-white/[0.02] p-4">
	  <div class="text-xs text-white/40">Active (1h)</div>
	  <div class="text-xl font-semibold">{{ stats.active_last_hour if stats is defined else "-" }}</div>
	</div>

	<div class="rounded-xl border border-white/10 bg-white/[0.02] p-4">
	  <div class="text-xs text-white/40">/start</div>
	  <div class="text-xl font-semibold">{{ stats.total_starts if stats is defined else "-" }}</div>
	</div>

	<div class="rounded-xl border border-white/10 bg-white/[0.02] p-4">
	  <div class="text-xs text-white/40">Messages</div>
	  <div class="text-xl font-semibold">{{ stats.total_messages if stats is defined else "-" }}</div>
	</div>
  </div>

  <!-- USERS TABLE -->
  <div class="rounded-2xl border border-white/10 bg-white/[0.02] p-4 mb-8">
	<div class="flex items-center justify-between mb-3">
	  <div class="text-sm font-medium">Latest users</div>

	  <div class="flex items-center gap-3">
		<div class="text-xs text-white/40">
		  {{ stats.total_users if stats is defined else "" }}
		</div>

		<a
		  href="/export/users.xlsx"
		  class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 text-sm hover:bg-white/15"
		>
		  ⬇️ Export Excel
		</a>
	  </div>
	</div>

	<div class="overflow-x-auto">
	  <table class="w-full text-sm">
		<thead class="text-white/50">
		  <tr class="border-b border-white/10">
			<th class="text-left py-2 pr-4 font-medium">user_id</th>
			<th class="text-left py-2 pr-4 font-medium">username</th>
			<th class="text-left py-2 pr-4 font-medium">first_seen</th>
			<th class="text-left py-2 pr-4 font-medium">last_seen</th>
			<th class="text-left py-2 pr-4 font-medium">starts</th>
			<th class="text-left py-2 pr-2 font-medium">msgs</th>
		  </tr>
		</thead>

		<tbody class="text-white/80">
		  {% if users is defined and users|length > 0 %}
			{% for u in users %}
			  <tr class="border-b border-white/5 hover:bg-white/[0.03]">
				<td class="py-2 pr-4">{{ u.user_id }}</td>
				<td class="py-2 pr-4">
				  {% if u.username %}
					@{{ u.username }}
				  {% else %}
					<span class="text-white/35">—</span>
				  {% endif %}
				</td>
				<td class="py-2 pr-4 text-white/60">{{ u.first_seen }}</td>
				<td class="py-2 pr-4 text-white/60">{{ u.last_seen }}</td>
				<td class="py-2 pr-4">{{ u.starts_count }}</td>
				<td class="py-2 pr-2">{{ u.messages_count }}</td>
			  </tr>
			{% endfor %}
		  {% else %}
			<tr>
			  <td colspan="6" class="py-3 text-white/50">
				Нет данных по пользователям. Проверь что bot пишет в таблицу bot_users.
			  </td>
			</tr>
		  {% endif %}
		</tbody>
	  </table>
	</div>
  </div>

  <!-- FLOWS HEADER -->
  <div class="flex items-start justify-between gap-4">
	<div>
	  <h1 class="text-base font-medium">Flows</h1>
	  <div class="text-xs text-white/40 mt-1">
		Порядок flow меняется ↑/↓. Удаление — безопасно (сотрёт блоки).
	  </div>
	  <div class="text-xs text-white/40 mt-1">
		⚙️ Mode: <span class="text-white/60">OFF</span> — ничего не отправлять,
		<span class="text-white/60">MANUAL</span> — только по кнопке/ручному запуску,
		<span class="text-white/60">AUTO</span> — по расписанию после /start.
	  </div>
	</div>

	<form method="post" action="/flow/new" class="flex items-center gap-2">
	  <input
		type="text"
		name="name"
		required
		autocomplete="off"
		placeholder="new flow name (e.g. day4)"
		class="w-56 px-3 py-2 rounded-xl bg-black/40 border border-white/10 text-sm"
	  />
	  <button
		type="submit"
		class="px-4 py-2 rounded-xl bg-white text-black text-sm font-medium hover:opacity-90"
	  >
		+ New flow
	  </button>
	</form>
  </div>

  <!-- FLOWS LIST -->
  <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-3">
	{% for f in flows %}
	  {% set tr = (triggers[f] if (triggers is defined and f in triggers) else None) %}
	  {% set mode = (tr.mode if tr and tr.mode is defined else "manual") %}

	  <div class="rounded-2xl border border-white/10 bg-white/[0.02] px-4 py-4">
		<div class="flex items-center justify-between gap-3">
		  <a href="/flow/{{ f }}" class="min-w-0">
			<div class="font-medium truncate">{{ f }}</div>
			<div class="text-xs text-white/35 mt-1">open →</div>
		  </a>

		  <div class="flex items-center gap-2">
			<form method="post" action="/flow/{{ f }}/up">
			  <button type="submit" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-sm hover:bg-white/10">↑</button>
			</form>

			<form method="post" action="/flow/{{ f }}/down">
			  <button type="submit" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-sm hover:bg-white/10">↓</button>
			</form>

			<form method="post" action="/flow/{{ f }}/delete" onsubmit="return confirm('Удалить flow и все блоки внутри?')">
			  <button type="submit" class="px-3 py-2 rounded-xl bg-red-500/10 border border-red-500/20 text-sm hover:bg-red-500/20 text-red-200">
				Delete
			  </button>
			</form>
		  </div>
		</div>

		<!-- MODE + AUTO SETTINGS -->
		<div class="mt-4 rounded-2xl border border-white/10 bg-black/20 p-3">
		  <div class="flex items-center justify-between gap-3">
			<div class="text-xs text-white/55">
			  Delivery mode
			</div>

			{% if mode == "auto" %}
			  <span class="text-[11px] px-2 py-1 rounded-lg bg-emerald-500/10 border border-emerald-500/20 text-emerald-200">AUTO</span>
			{% elif mode == "off" %}
			  <span class="text-[11px] px-2 py-1 rounded-lg bg-red-500/10 border border-red-500/20 text-red-200">OFF</span>
			{% else %}
			  <span class="text-[11px] px-2 py-1 rounded-lg bg-white/5 border border-white/10 text-white/60">MANUAL</span>
			{% endif %}
		  </div>

		  <form method="post" action="/flow/{{ f }}/trigger" class="mt-3 space-y-2" data-flow-settings>
			<div class="flex flex-wrap items-center gap-2">
			  <label class="text-xs text-white/60">Mode</label>

			  <select name="mode" class="px-3 py-2 rounded-xl bg-black/40 border border-white/10 text-sm" data-mode>
				<option value="off" {% if mode=="off" %}selected{% endif %}>off (ничего не слать)</option>
				<option value="manual" {% if mode=="manual" %}selected{% endif %}>manual (только кнопка)</option>
				<option value="auto" {% if mode=="auto" %}selected{% endif %}>auto (по времени после /start)</option>
			  </select>

			  <button type="submit"
				class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 text-sm hover:bg-white/15">
				Save
			  </button>

			  <form method="post" action="/flow/{{ f }}/trigger/delete"
					onsubmit="return confirm('Сбросить настройки доставки для этого flow?')">
				<button type="submit"
				  class="px-3 py-2 rounded-xl bg-red-500/10 border border-red-500/20 text-sm hover:bg-red-500/20 text-red-200">
				  Reset
				</button>
			  </form>
			</div>

			<!-- AUTO options -->
			<div class="flex flex-wrap items-center gap-2" data-auto>
			  <div class="text-xs text-white/60">Auto-send after /start</div>

			  <input
				type="number"
				name="offset_value"
				min="0"
				step="1"
				value="{{ tr.offset_value if tr and tr.offset_value is defined else 0 }}"
				class="w-24 px-3 py-2 rounded-xl bg-black/40 border border-white/10 text-sm"
				placeholder="1"
			  />

			  <select name="offset_unit" class="px-3 py-2 rounded-xl bg-black/40 border border-white/10 text-sm">
				{% set unit = (tr.offset_unit if tr and tr.offset_unit is defined else "days") %}
				<option value="minutes" {% if unit=="minutes" %}selected{% endif %}>minutes</option>
				<option value="hours" {% if unit=="hours" %}selected{% endif %}>hours</option>
				<option value="days" {% if unit=="days" %}selected{% endif %}>days</option>
			  </select>

			  <label class="flex items-center gap-2 text-xs text-white/60 ml-2">
				<input type="checkbox" name="enabled" value="1"
				  {% if tr and tr.enabled %}checked{% endif %}
				  class="accent-white"
				/>
				enabled
			  </label>
			</div>

			<div class="text-[11px] text-white/35" data-auto-hint>
			  Пример: <span class="text-white/60">day2</span> → <span class="text-white/60">1 days</span>,
			  <span class="text-white/60">day3</span> → <span class="text-white/60">2 days</span>.
			</div>

		  </form>
		</div>

	  </div>
	{% endfor %}
  </div>

  {% if flows|length == 0 %}
	<div class="mt-4 text-white/50 text-sm">Нет flows. Запусти seed.py.</div>
  {% endif %}

  <script>
	(function(){
	  const blocks = document.querySelectorAll('[data-flow-settings]');
	  blocks.forEach(form => {
		const modeSel = form.querySelector('[data-mode]');
		const autoRow = form.querySelector('[data-auto]');
		const hint = form.querySelector('[data-auto-hint]');

		function apply() {
		  const m = (modeSel?.value || 'manual');
		  const showAuto = (m === 'auto');
		  if (autoRow) autoRow.style.display = showAuto ? 'flex' : 'none';
		  if (hint) hint.style.display = showAuto ? 'block' : 'none';
		}

		if (modeSel) modeSel.addEventListener('change', apply);
		apply();
	  });
	})();
  </script>

{% endblock %}