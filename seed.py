# seed.py
import asyncio
import json

from db import init_db, get_pool

VIDEO = "https://youtu.be/VZhCbEQUD-A"


async def seed():
	# 1) –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—ã
	await init_db()
	pool = await get_pool()

	async with pool.acquire() as con:
		# 2) –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å flows ‚Äî –ù–ï —Å–∏–¥–∏–º (–Ω–∏—á–µ–≥–æ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)
		existing = await con.fetchval("SELECT COUNT(*) FROM flows")
		if (existing or 0) > 0:
			print("‚úÖ Seed skipped: flows already exist")
			return

		# 3) –≤—Å—Ç–∞–≤–ª—è–µ–º content_blocks (–±–µ–∑ DELETE!)
		rows = [
			# ================= WELCOME =================
			("welcome", 1, "circle", "", "", "media/welcome.mp4", "", "", 1.2, "", "", ""),
			("welcome", 2, "text", "", "üëã <b>–ü—Ä–∏–≤–µ—Ç.</b>\n\n"
									  "–≠—Ç–∏ —Ç—Ä–∏ –¥–Ω—è ‚Äî –Ω–µ –º–æ—Ç–∏–≤–∞—Ü–∏—è.\n"
									  "–≠—Ç–æ —Å–∏—Å—Ç–µ–º–∞, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–µ–ª–æ–≤–µ–∫–∞ –∫ —Å–µ–±–µ.\n\n"
									  "üöÄ <b>–î–∞–≤–∞–π –Ω–∞—á–Ω—ë–º.</b>",
			 "", "", "", 1.0, "", "", ""),
			("welcome", 3, "text", "", "üéì <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ 3-–¥–Ω–µ–≤–Ω—ã–π –∫—É—Ä—Å</b>\n"
									  "¬´–¢—Ä–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å—á–∞—Å—Ç—å—è¬ª.\n\n"
									  "–ï—Å–ª–∏ —Ç—ã –ø—Ä–æ–π–¥—ë—à—å –µ–≥–æ —á–µ—Å—Ç–Ω–æ ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—á—É–≤—Å—Ç–≤—É–µ—à—å —É–∂–µ –Ω–∞ 3-–π –¥–µ–Ω—å.",
			 "", "", "", 1.0, "", "", ""),

			# ================= DAY 1 =================
			("day1", 1, "circle", "", "", "media/welcome.mp4", "", "", 1.2, "", "", ""),
			("day1", 2, "text", "", "üîµ <b>–î–ï–ù–¨ 1 ‚Äî –ë–õ–ê–ì–û–î–ê–†–ù–û–°–¢–¨</b>\n\n"
								   "üé¨ <b>–í–∏–¥–µ–æ —É—Ä–æ–∫:</b>",
			 "", "", "", 1.0, "", "", ""),
			("day1", 3, "video", "–í–∏–¥–µ–æ —É—Ä–æ–∫", "", "", VIDEO, "", 1.0, "", "", ""),
			("day1", 4, "text", "", "‚úçÔ∏è <b>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ:</b>\n"
								   "‚Äî –ß—Ç–æ –≤ –º–æ–µ–π –∂–∏–∑–Ω–∏ —Å–µ–π—á–∞—Å –ù–ï –º–æ—ë?\n"
								   "‚Äî –ì–¥–µ —è –∂–∏–≤—É ¬´–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–µ¬ª?\n\n"
								   "üì© –û—Ç–ø—Ä–∞–≤—å —Å–µ–±–µ –∏–ª–∏ –≤ @client_support",
			 "", "", "", 1.0, "", "", ""),

			# ================= DAY 2 =================
			("day2", 1, "circle", "", "", "media/welcome.mp4", "", "", 1.2, "", "", ""),
			("day2", 2, "text", "", "üîµ <b>–î–ï–ù–¨ 2 ‚Äî –û–ë–£–ß–ï–ù–ò–ï</b>\n\n"
								   "üé¨ <b>–í–∏–¥–µ–æ —É—Ä–æ–∫:</b>",
			 "", "", "", 1.0, "", "", ""),
			("day2", 3, "video", "–í–∏–¥–µ–æ —É—Ä–æ–∫", "", "", VIDEO, "", 1.0, "", "", ""),
			("day2", 4, "text", "", "‚úçÔ∏è <b>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ:</b>\n"
								   "–í—ã–±–µ—Ä–∏ –æ–¥–Ω—É —Å—Ç—Ä–µ—Å—Å-—Ç–µ–º—É.\n"
								   "15 –º–∏–Ω—É—Ç –∏–∑—É—á–∏ —Å—Ç–∞—Ç—å—é –∏–ª–∏ –≤–∏–¥–µ–æ.\n"
								   "–ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π: <b>–ü–æ–Ω—è–ª / –ü–ª–∞–Ω–∏—Ä—É—é / –ü–æ–¥–µ–ª—é—Å—å / –ü–æ–≤—Ç–æ—Ä—é</b>.",
			 "", "", "", 1.0, "", "", ""),

			# ================= DAY 3 =================
			("day3", 1, "circle", "", "", "media/welcome.mp4", "", "", 1.2, "", "", ""),
			("day3", 2, "text", "", "üîµ <b>–î–ï–ù–¨ 3 ‚Äî –ì–ò–ë–ö–û–°–¢–¨ –ú–´–®–õ–ï–ù–ò–Ø</b>\n\n"
								   "üé¨ <b>–í–∏–¥–µ–æ —É—Ä–æ–∫:</b>",
			 "", "", "", 1.0, "", "", ""),
			("day3", 3, "video", "–í–∏–¥–µ–æ —É—Ä–æ–∫", "", "", VIDEO, "", 1.0, "", "", ""),
			("day3", 4, "text", "", "‚úÖ <b>–ü—Ä–∞–∫—Ç–∏–∫–∞:</b>\n"
								   "1) ¬´–Ø –∑–∞–º–µ—á–∞—é –º—ã—Å–ª—å –æ —Ç–æ–º, —á—Ç–æ‚Ä¶¬ª\n"
								   "2) –ü–µ—Ä–µ–∏–º–µ–Ω—É–π ¬´—É–∂–∞—Å/–¥–Ω–æ¬ª –≤ ¬´—É—Ä–æ–∫/–∏—Å–ø—ã—Ç–∞–Ω–∏–µ/–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–æ—Å—Ç–∞¬ª.",
			 "", "", "", 1.0, "", "", ""),

			# ================= UPSELL YEAR =================
			("upsell_year", 1, "text", "", "üî• <b>–≠—Ç–∏ 3 –¥–Ω—è ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ.</b>\n\n"
										  "–•–æ—á–µ—à—å —Å–∏—Å—Ç–µ–º–Ω–æ —Ä–∞—Å—Ç–∏ –∏ –Ω–µ –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å—Å—è –Ω–∞–∑–∞–¥?\n"
										  "üëâ –í—Å—Ç—É–ø–∞–π –≤ <b>–ö–ª—É–± –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–æ–≤ –°—á–∞—Å—Ç—å—è</b>\n\n"
										  "üí∏ 588 EUR ‚Üí ‚úÖ <b>499 EUR</b>",
			 "", "", "", 1.0, "", "", ""),
			("upsell_year", 2, "buttons", "–í—ã–±–µ—Ä–∏ —Ç–∞—Ä–∏—Ñ", "", "", "",
			 json.dumps([{"text": "üü¢ –í—Å—Ç—É–ø–∏—Ç—å –≤ –∫–ª—É–± ‚Äî –ì–û–î", "url": "https://t.me/client_support"}], ensure_ascii=False),
			 1.0, "", "", ""),

			# ================= UPSELL INSTALLMENT =================
			("upsell_installment", 1, "circle", "", "", "media/welcome.mp4", "", "", 1.2, "", "", ""),
			("upsell_installment", 2, "text", "", "üéÅ <b>–≠–≤—Ä–∏–∫–∞:</b>\n"
												 "–¥–æ—Å—Ç—É–ø–Ω–∞ —Ä–∞—Å—Å—Ä–æ—á–∫–∞ –Ω–∞ –≥–æ–¥–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É.\n"
												 "–ù–∞–ø–∏—à–∏ –≤ @client_support –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è.",
			 "", "", "", 1.0, "", "", ""),

			# ================= UPSELL MONTH =================
			("upsell_month", 1, "circle", "", "", "media/welcome.mp4", "", "", 1.2, "", "", ""),
			("upsell_month", 2, "text", "", "üôÇ –ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.\n"
										   "–ù–∞—á–Ω–∏ —Å –º–∞–ª–æ–≥–æ.\n\n"
										   "<b>–ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Å—è</b>.",
			 "", "", "", 1.0, "", "", ""),
			("upsell_month", 3, "buttons", "–ü–æ–º–µ—Å—è—á–Ω–æ", "", "", "",
			 json.dumps([{"text": "üü° –í—Å—Ç—É–ø–∏—Ç—å –≤ –∫–ª—É–± ‚Äî –ø–æ–º–µ—Å—è—á–Ω–æ", "url": "https://t.me/client_support"}], ensure_ascii=False),
			 1.0, "", "", ""),
		]

		await con.executemany(
			"""
			INSERT INTO content_blocks(
				flow, position, type,
				title, text,
				circle_path, video_url,
				buttons_json, delay_seconds,
				file_path, file_kind, file_name
			)
			VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12)
			""",
			rows
		)

		# 4) –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º flows –ø–æ –±–ª–æ–∫–∞–º
		flows = await con.fetch("SELECT DISTINCT flow FROM content_blocks ORDER BY flow")
		order = 1
		for r in flows:
			f = r["flow"]
			await con.execute(
				"INSERT INTO flows(name, sort_order) VALUES ($1, $2) ON CONFLICT(name) DO NOTHING",
				f, order
			)
			order += 1

		# 5) default triggers (day2/day3) ‚Äî safe upsert
		triggers = [
			("day2", 1 * 86400, 1),
			("day3", 2 * 86400, 1),
		]
		await con.executemany(
			"""
			INSERT INTO flow_triggers(flow, trigger, offset_seconds, is_active)
			VALUES ($1, 'after_start', $2, $3)
			ON CONFLICT(flow) DO UPDATE SET
				trigger=EXCLUDED.trigger,
				offset_seconds=EXCLUDED.offset_seconds,
				is_active=EXCLUDED.is_active
			""",
			triggers
		)

	print("‚úÖ DB SEEDED (Postgres) + TRIGGERS")


if __name__ == "__main__":
	asyncio.run(seed())